<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Elephant Race Visualizer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>üêò Elephant Race Visualizer üêò</h1>
        
        <div class="source-link">
            <a href="https://github.com/aglucky/elephant_race" target="_blank" rel="noopener noreferrer">
                üìñ View Source Code
            </a>
        </div>
        
        <div class="input-section">
            <label for="elephantCount">Number of elephants:</label>
            <div class="input-with-buttons">
                <button type="button" class="decrease-btn" onclick="decreaseElephants()">‚àí</button>
                <input type="number" id="elephantCount" placeholder="Number of elephants" min="1" value="10" oninput="visualizeElephants()">
                <button type="button" class="increase-btn" onclick="increaseElephants()">+</button>
            </div>
        </div>
        
        <div class="comparison-section">
            <h3>üêò Simulation</h3>
            <div class="comparison-controls">
                <div class="elephant-selector">
                    <label for="elephant1">First Elephant:</label>
                    <div class="combobox-container">
                        <input type="text" id="elephant1Combobox" class="combobox-input" placeholder="Search elephant..." autocomplete="off">
                        <div id="elephant1Dropdown" class="combobox-dropdown" style="display: none;"></div>
                    </div>
                </div>
                <div class="elephant-selector">
                    <label for="elephant2">Second Elephant:</label>
                    <div class="combobox-container">
                        <input type="text" id="elephant2Combobox" class="combobox-input" placeholder="Search elephant..." autocomplete="off">
                        <div id="elephant2Dropdown" class="combobox-dropdown" style="display: none;"></div>
                    </div>
                </div>
            </div>
            <div id="comparison-results" class="comparison-results"></div>
        </div>
        
        <div id="results"></div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Calculating elephant groups...</div>
            <div class="loading-subtext">This may take a moment for large numbers</div>
        </div>
    </div>

    <script>
        const maxElephants = 1_000_000;
        let worker = null;
        
        // Utility functions
        const showLoading = () => document.getElementById('loadingOverlay').style.display = 'flex';
        const hideLoading = () => document.getElementById('loadingOverlay').style.display = 'none';
        const getElement = id => document.getElementById(id);
        
        function initializeWorker() {
            if (typeof Worker !== 'undefined') {
                try {
                    worker = new Worker('elephant-worker.js');
                    worker.onmessage = e => {
                        // Clear the loading timeout if it exists
                        if (window.currentLoadingTimeout) {
                            clearTimeout(window.currentLoadingTimeout);
                            window.currentLoadingTimeout = null;
                        }
                        // Only hide loading if it was actually shown
                        if (window.loadingShown) {
                            hideLoading();
                        }
                        e.data.success ? displayResults(e.data.result) : 
                            getElement('results').innerHTML = `<div class="error">Error: ${e.data.error}</div>`;
                    };
                    worker.onerror = error => {
                        // Clear the loading timeout if it exists
                        if (window.currentLoadingTimeout) {
                            clearTimeout(window.currentLoadingTimeout);
                            window.currentLoadingTimeout = null;
                        }
                        // Only hide loading if it was actually shown
                        if (window.loadingShown) {
                            hideLoading();
                        }
                        getElement('results').innerHTML = '<div class="error">Error: Worker failed to execute.</div>';
                        console.error('Worker error:', error);
                    };
                } catch (error) {
                    console.error('Failed to create worker:', error);
                    worker = null;
                }
            }
        }
        
        function displayResults(result) {
            const { numElephants, minGroups, k, encodings, groups } = result;
            
            let html = `
                <div class="stats">
                    <h3>Grouping Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${numElephants}</div>
                            <div class="stat-label">Total Elephants</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${minGroups}</div>
                            <div class="stat-label">Minimum Groups</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${k}</div>
                            <div class="stat-label">Groups Per Elephant</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${encodings}</div>
                            <div class="stat-label">Valid Encodings</div>
                        </div>
                    </div>
                </div>
            `;
            
            html += `
                <div class="results-tabs">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('groupings')">üêò Elephant Groups</button>
                        <button class="tab-button" onclick="switchTab('encodings')">üî¢ Individual Encodings</button>
                    </div>
                    
                    <div id="groupings-tab" class="tab-content active">
                        ${numElephants <= 1000 ? 
                            `<div class="groups-search">
                                <input type="text" id="groupSearch" placeholder="Search elephant..." class="search-input">
                                <div class="search-info">Showing <span id="visibleGroupsCount">${groups.filter(g => g.length > 0).length}</span> of ${groups.filter(g => g.length > 0).length} groups</div>
                            </div>
                            <div class="groups-container" id="groupsContainer">
                                ${groups.map((group, index) => {
                                    if (group.length > 0) {
                                        const isCollapsed = true; // Start collapsed by default
                                        const elephantsPerRow = 10; // Assume 10 elephants per row for layout
                                        const totalRows = Math.ceil(group.length / elephantsPerRow);
                                        const hasMultipleRows = totalRows > 2;
                                        
                                        if (hasMultipleRows) {
                                            // Show only first 2 rows worth of elephants
                                            const visibleElephants = group.slice(0, elephantsPerRow * 2);
                                            const hiddenElephants = group.slice(elephantsPerRow * 2);
                                            
                                            return `
                                                <div class="group" data-group-index="${index}" data-group-elephants="${group.join(',')}">
                                                    <div class="group-header" onclick="toggleGroup(${index})">
                                                        <div class="group-title">Group ${index + 1}</div>
                                                        <div class="group-controls">
                                                            <span class="elephant-count">${group.length} elephants </span>
                                                            <span class="expand-icon ${isCollapsed ? 'collapsed' : 'expanded'}">‚ñº</span>
                                                        </div>
                                                    </div>
                                                    <div class="elephants">
                                                        ${visibleElephants.map(elephantNum => 
                                                            `<div class="elephant">üêò<span class="elephant-number">${elephantNum}</span></div>`
                                                        ).join('')}
                                                        ${hiddenElephants.map(elephantNum => 
                                                            `<div class="elephant hidden-elephant" data-group-index="${index}" style="display: ${isCollapsed ? 'none' : 'flex'}">üêò<span class="elephant-number">${elephantNum}</span></div>`
                                                        ).join('')}
                                                    </div>
                                                </div>
                                            `;
                                        } else {
                                            // Show all elephants if 2 rows or less
                                            return `
                                                <div class="group" data-group-elephants="${group.join(',')}">
                                                    <div class="group-title">Group ${index + 1}</div>
                                                    <div class="elephants">
                                                        ${group.map(elephantNum => 
                                                            `<div class="elephant">üêò<span class="elephant-number">${elephantNum}</span></div>`
                                                        ).join('')}
                                                    </div>
                                                </div>
                                            `;
                                        }
                                    }
                                    return '';
                                }).join('')}
                            </div>` : 
                            `<div class="large-number-notice">
                                <h3>üìä Groups Generated Successfully</h3>
                                <p><em>Individual elephant assignments are hidden for numbers above 1,000 to maintain performance.</em></p>
                            </div>`
                        }
                    </div>
                    
                    <div id="encodings-tab" class="tab-content">
                        ${numElephants <= 1000 ? 
                            `<div class="encodings-search">
                                <input type="text" id="elephantSearch" placeholder="Search elephant..." class="search-input">
                                <div class="search-info">Showing <span id="visibleCount">${numElephants}</span> of ${numElephants} elephants</div>
                            </div>
                            <div class="encodings-grid" id="encodingsGrid">
                                ${Array.from({length: numElephants}, (_, i) => {
                                    const elephantNum = i + 1;
                                    const encoding = getEncodings(minGroups, k)[i];
                                    if (encoding) {
                                        return `
                                            <div class="elephant-encoding" data-elephant-number="${elephantNum}">
                                                <div class="elephant-header">
                                                    <span class="elephant-icon">üêò</span>
                                                    <span class="elephant-number">${elephantNum}</span>
                                                </div>
                                                <div class="encoding-display">
                                                    ${encoding.split('').map((bit, bitIndex) => 
                                                        `<span class="encoding-bit ${bit === '1' ? 'active' : 'inactive'}" title="Group ${bitIndex + 1}">${bit}</span>`
                                                    ).join('')}
                                                </div>
                                            </div>
                                        `;
                                    }
                                    return '';
                                }).join('')}
                            </div>` : 
                            `<div class="large-number-notice">
                                <h3>üî¢ Encodings Generated Successfully</h3>
                                <p><em>Individual elephant encodings are hidden for numbers above 1,000 to maintain performance.</em></p>
                                <p>Use the comparison tool above to view specific elephant encodings.</p>
                            </div>`
                        }
                    </div>
                </div>
            `;
            
            getElement('results').innerHTML = html;
            populateElephantSelectors(numElephants, minGroups, k);
            
            // Initialize search functionality immediately for both tabs
            initializeSearch();
            initializeGroupSearch();
        }
        
        function toggleGroup(groupIndex) {
            const group = document.querySelector(`[data-group-index="${groupIndex}"]`);
            if (!group) return;
            
            const hiddenElephants = group.querySelectorAll('.hidden-elephant');
            const expandIcon = group.querySelector('.expand-icon');
            
            if (hiddenElephants.length > 0) {
                const isCurrentlyHidden = hiddenElephants[0].style.display === 'none';
                
                if (isCurrentlyHidden) {
                    // Expand the group - show all hidden elephants
                    hiddenElephants.forEach(elephant => {
                        elephant.style.display = 'flex';
                    });
                    if (expandIcon) {
                        expandIcon.classList.remove('collapsed');
                        expandIcon.classList.add('expanded');
                        expandIcon.textContent = '‚ñ≤';
                    }
                } else {
                    // Collapse the group - hide all hidden elephants
                    hiddenElephants.forEach(elephant => {
                        elephant.style.display = 'none';
                    });
                    if (expandIcon) {
                        expandIcon.classList.remove('expanded');
                        expandIcon.classList.add('collapsed');
                        expandIcon.textContent = '‚ñº';
                    }
                }
            }
        }
        
        function collapseAllGroups() {
            const groups = document.querySelectorAll('.group');
            groups.forEach(group => {
                const hiddenElephants = group.querySelectorAll('.hidden-elephant');
                const expandIcon = group.querySelector('.expand-icon');
                
                if (hiddenElephants.length > 0) {
                    hiddenElephants.forEach(elephant => {
                        elephant.style.display = 'none';
                    });
                    if (expandIcon) {
                        expandIcon.classList.remove('expanded');
                        expandIcon.classList.add('collapsed');
                        expandIcon.textContent = '‚ñº';
                    }
                }
            });
        }
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Initialize search functionality when encodings tab is opened
            if (tabName === 'encodings') {
                initializeSearch();
            }
            
            // Initialize group search functionality when groupings tab is opened
            if (tabName === 'groupings') {
                initializeGroupSearch();
            }
        }
        
        function searchElephants() {
            const searchInput = document.getElementById('elephantSearch');
            const searchTerm = searchInput.value.trim();
            const elephantCards = document.querySelectorAll('.elephant-encoding');
            const visibleCountSpan = document.getElementById('visibleCount');
            
            let visibleCount = 0;
            
            elephantCards.forEach(card => {
                const elephantNumber = card.getAttribute('data-elephant-number');
                
                if (searchTerm === '' || elephantNumber.includes(searchTerm)) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Update the visible count display
            if (visibleCountSpan) {
                visibleCountSpan.textContent = visibleCount;
            }
        }
        
        function initializeSearch() {
            const searchInput = document.getElementById('elephantSearch');
            if (searchInput) {
                // Clear any existing event listeners
                searchInput.removeEventListener('input', searchElephants);
                // Add new event listener
                searchInput.addEventListener('input', searchElephants);
                // Clear the search input
                searchInput.value = '';
                // Reset the display to show all elephants
                searchElephants();
            }
        }
        
        function searchGroups() {
            const searchInput = document.getElementById('groupSearch');
            const searchTerm = searchInput.value.trim();
            const groupElements = document.querySelectorAll('.group');
            const visibleGroupsCountSpan = document.getElementById('visibleGroupsCount');
            
            let visibleCount = 0;
            
            groupElements.forEach(group => {
                const elephants = group.querySelectorAll('.elephant');
                let hasVisibleElephants = false;
                
                elephants.forEach(elephant => {
                    const elephantNumber = elephant.querySelector('.elephant-number').textContent;
                    
                    if (searchTerm === '' || elephantNumber.includes(searchTerm)) {
                        elephant.style.display = 'flex';
                        hasVisibleElephants = true;
                    } else {
                        elephant.style.display = 'none';
                    }
                });
                
                // Show group if it has any visible elephants
                if (hasVisibleElephants) {
                    group.style.display = 'block';
                    visibleCount++;
                } else {
                    group.style.display = 'none';
                }
            });
            
            // Update the visible count display
            if (visibleGroupsCountSpan) {
                visibleGroupsCountSpan.textContent = visibleCount;
            }
            
            // If search is cleared, collapse all groups
            if (searchTerm === '') {
                collapseAllGroups();
            }
        }
        
        function initializeGroupSearch() {
            const searchInput = document.getElementById('groupSearch');
            if (searchInput) {
                // Clear any existing event listeners
                searchInput.removeEventListener('input', searchGroups);
                // Add new event listener
                searchInput.addEventListener('input', searchGroups);
                // Clear the search input
                searchInput.value = '';
                // Collapse all groups by default
                collapseAllGroups();
                // Reset the display to show all elephants
                searchGroups();
            }
        }
        
        function populateElephantSelectors(numElephants) {
            // Store elephant data for combobox autocomplete
            window.elephantData = Array.from({length: numElephants}, (_, i) => ({
                id: i + 1,
                label: `Elephant ${i + 1}`
            }));
            
            // Initialize comboboxes
            initializeCombobox('elephant1Combobox', 'elephant1Dropdown', 1);
            initializeCombobox('elephant2Combobox', 'elephant2Dropdown', 2);
            
            getElement('comparison-results').innerHTML = '';
        }
        
        function initializeCombobox(inputId, dropdownId, elephantNumber) {
            const input = getElement(inputId);
            const dropdown = getElement(dropdownId);
            
            // Input event handlers
            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                
                // Check if input is a valid number
                const numberInput = parseInt(query);
                if (!isNaN(numberInput) && numberInput >= 1 && numberInput <= window.elephantData.length) {
                    // Valid number input - find the elephant
                    const elephant = window.elephantData.find(e => e.id === numberInput);
                    if (elephant) {
                        input.dataset.selectedId = elephant.id;
                        dropdown.style.display = 'none';
                        compareElephants();
                        return;
                    }
                }
                
                if (query.length === 0) {
                    dropdown.style.display = 'none';
                    input.dataset.selectedId = '';
                    return;
                }
                
                const filteredElephants = window.elephantData.filter(elephant => 
                    elephant.label.toLowerCase().includes(query) || 
                    `üêò ${elephant.label}`.toLowerCase().includes(query)
                );
                
                showDropdown(dropdown, filteredElephants, elephantNumber);
            });
            
            input.addEventListener('focus', () => {
                if (input.value.length > 0) {
                    const query = input.value.toLowerCase();
                    const filteredElephants = window.elephantData.filter(elephant => 
                        elephant.label.toLowerCase().includes(query) || 
                        `üêò ${elephant.label}`.toLowerCase().includes(query)
                    );
                    showDropdown(dropdown, filteredElephants, elephantNumber);
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
            
            // Handle keyboard navigation
            input.addEventListener('keydown', (e) => {
                const visibleItems = dropdown.querySelectorAll('.dropdown-item');
                const currentIndex = Array.from(visibleItems).findIndex(item => item.classList.contains('selected'));
                
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        navigateDropdown(visibleItems, currentIndex, 1, elephantNumber);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateDropdown(visibleItems, currentIndex, -1, elephantNumber);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (currentIndex >= 0 && visibleItems[currentIndex]) {
                            selectElephant(visibleItems[currentIndex], elephantNumber);
                        } else {
                            // Try to handle direct number input
                            const numberInput = parseInt(input.value);
                            if (!isNaN(numberInput) && numberInput >= 1 && numberInput <= window.elephantData.length) {
                                const elephant = window.elephantData.find(e => e.id === numberInput);
                                if (elephant) {
                                    selectElephant({ dataset: { id: elephant.id, label: elephant.label } }, elephantNumber);
                                }
                            }
                        }
                        break;
                    case 'Escape':
                        dropdown.style.display = 'none';
                        input.blur();
                        break;
                }
            });
        }
        
        function showDropdown(dropdown, elephants, elephantNumber) {
            if (elephants.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            dropdown.innerHTML = elephants.map(elephant => 
                `<div class="dropdown-item" data-id="${elephant.id}" data-label="${elephant.label}">
                    üêò ${elephant.label}
                </div>`
            ).join('');
            
            dropdown.style.display = 'block';
            
            // Add click handlers to dropdown items
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', () => selectElephant(item, elephantNumber));
                item.addEventListener('mouseenter', () => {
                    dropdown.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                });
            });
        }
        
        function selectElephant(item, elephantNumber) {
            const elephantId = parseInt(item.dataset.id);
            const elephantLabel = item.dataset.label;
            
            // Update the combobox input
            const inputId = `elephant${elephantNumber}Combobox`;
            const input = getElement(inputId);
            input.value = `üêò ${elephantLabel}`;
            input.dataset.selectedId = elephantId;
            
            // Hide dropdown
            const dropdownId = `elephant${elephantNumber}Dropdown`;
            getElement(dropdownId).style.display = 'none';
            
            // Trigger comparison
            compareElephants();
        }
        
        function navigateDropdown(items, currentIndex, direction, elephantNumber) {
            if (items.length === 0) return;
            
            // Remove current selection
            items.forEach(item => item.classList.remove('selected'));
            
            // Calculate new index
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = items.length - 1;
            if (newIndex >= items.length) newIndex = 0;
            
            // Add selection to new item
            items[newIndex].classList.add('selected');
            items[newIndex].scrollIntoView({ block: 'nearest' });
        }
        
        function highlightFirstDifference(encoding1, encoding2) {
            let highlightedEncoding = '';
            let firstDifferenceFound = false;
            
            for (let i = 0; i < encoding1.length; i++) {
                if (encoding1[i] === '1' && encoding2[i] === '0' && !firstDifferenceFound) {
                    highlightedEncoding += `<span class="highlighted-bit">${encoding1[i]}</span>`;
                    firstDifferenceFound = true;
                } else {
                    highlightedEncoding += encoding1[i];
                }
            }
            
            return highlightedEncoding;
        }
        
        function generateSummary(encoding1, encoding2) {
            for (let i = 0; i < encoding1.length; i++) {
                if (encoding1[i] === '1' && encoding2[i] === '0') {
                    const elephant1 = parseInt(document.getElementById('elephant1Combobox').dataset.selectedId);
                    const elephant2 = parseInt(document.getElementById('elephant2Combobox').dataset.selectedId);
                    return `Group ${i + 1} will have 1st place elephant (üêò${elephant1}) but not 2nd place elephant (üêò${elephant2})`;
                }
            }
            return 'No key difference found';
        }
        
        function compareElephants() {
            const elephant1Input = getElement('elephant1Combobox');
            const elephant2Input = getElement('elephant2Combobox');
            const elephant1 = parseInt(elephant1Input.dataset.selectedId);
            const elephant2 = parseInt(elephant2Input.dataset.selectedId);
            
            if (!elephant1 || !elephant2) {
                getElement('comparison-results').innerHTML = '';
                return;
            }
            
            if (elephant1 === elephant2) {
                getElement('comparison-results').innerHTML = 
                    '<div class="comparison-error">Please select two different elephants to compare.</div>';
                return;
            }
            
            const numElephants = parseInt(getElement('elephantCount').value);
            const minGroups = getMinNumGroups(numElephants);
            const k = Math.floor(minGroups / 2);
            const encodings = getEncodings(minGroups, k);
            
            const [encoding1, encoding2] = [encodings[elephant1 - 1], encodings[elephant2 - 1]];
            
            if (!encoding1 || !encoding2) {
                getElement('comparison-results').innerHTML = 
                    '<div class="comparison-error">Could not retrieve encodings for the selected elephants.</div>';
                return;
            }
            
            const hasDifferences = encoding1.split('').some((bit, i) => bit === '1' && encoding2[i] === '0');
            
            const html = `
                <div class="comparison-display">
                    <h4>Encoding Comparison</h4>
                    <div class="encoding-comparison">
                        <div class="encoding-side-by-side">
                            <div class="encoding-item">
                                <div class="encoding-label">1st place elephant</div>
                                <div class="encoding-bits">${highlightFirstDifference(encoding1, encoding2)}</div>
                            </div>
                            <div class="encoding-item">
                                <div class="encoding-label">2nd place elephant</div>
                                <div class="encoding-bits">${encoding2}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-section">
                        <div class="summary-text">${generateSummary(encoding1, encoding2)}</div>
                    </div>
                    
                    ${!hasDifferences ? '<div class="no-differences">No differences found - 1st place elephant has no 1s that 2nd place elephant doesn\'t have.</div>' : ''}
                </div>
            `;
            
            getElement('comparison-results').innerHTML = html;
        }
        
        function visualizeElephants() {
            const numElephants = parseInt(getElement('elephantCount').value);
            
            if (!Number.isInteger(numElephants) || numElephants < 1 || numElephants > maxElephants) {
                getElement('results').innerHTML = 
                    `<div class="error">Please enter a valid integer between 1 and ${maxElephants.toLocaleString()}.</div>`;
                return;
            }
            
            let loadingShown = false;
            
            // Show loading screen after 1 second delay
            const loadingTimeout = setTimeout(() => {
                showLoading();
                loadingShown = true;
                // Also update global state for worker
                if (worker) {
                    window.loadingShown = true;
                }
            }, 1000);
            
            if (worker) {
                worker.postMessage({ numElephants });
                // Store the timeout ID and loading state so worker can access them
                window.currentLoadingTimeout = loadingTimeout;
                window.loadingShown = false;
            } else {
                try {
                    const minGroups = getMinNumGroups(numElephants);
                    const k = Math.floor(minGroups / 2);
                    const encodings = getEncodings(minGroups, k);
                    let groups = Array.from({ length: minGroups }, () => []);
                    
                    for (let group = 0; group < minGroups; group++) {
                        for (let elephant = 0; elephant < numElephants; elephant++) {
                            if (encodings[elephant] && encodings[elephant][group] === '1') {
                                groups[group].push(elephant + 1);
                            }
                        }
                    }
                    
                    const result = { numElephants, minGroups, k, encodings: encodings.length, groups };
                    clearTimeout(loadingTimeout);
                    // Only hide loading if it was actually shown
                    if (loadingShown) {
                        hideLoading();
                    }
                    displayResults(result);
                    
                } catch (error) {
                    clearTimeout(loadingTimeout);
                    // Only hide loading if it was actually shown
                    if (loadingShown) {
                        hideLoading();
                    }
                    getElement('results').innerHTML = 
                        '<div class="error">Error: Could not generate groups for this number of elephants.</div>';
                }
            }
        }
        
        // Fallback functions for when worker is not available
        const binomialCoefficient = (n, k) => {
            if (!Number.isInteger(n) || !Number.isInteger(k) || n < 0 || k < 0) return 0;
            if (k === 0 || k === n) return 1;
            if (k === 1 || k === n - 1) return n;
            if (k > n) return 0;
            
            const effectiveK = Math.min(k, n - k);
            const result = Array.from({ length: effectiveK }, (_, i) => i).reduce((acc, i) => 
                (acc * (n - i)) / (i + 1), 1
            );
            return Math.round(result);
        };

        const getMinNumGroups = (num_elephants) => {
            for (let n = 0; n <= num_elephants; n++) {
                if (binomialCoefficient(n, Math.floor(n/2)) >= num_elephants) {
                    return n;
                }
            }
            throw new Error("No valid k found");
        };

        const getEncodings = (min_groups, k) => {
            let validEncodings = [];
            for (let i = 0; i <= Math.pow(2, min_groups); i++) {
                const binaryString = i.toString(2).padStart(min_groups, '0');
                if (binaryString.split('').filter(x => x == "1").length == k) {
                    validEncodings.push(binaryString);
                }
            }
            return validEncodings;
        };
        
        const changeElephants = (delta) => {
            const input = getElement('elephantCount');
            const currentValue = parseInt(input.value) || 10;
            const newValue = currentValue + delta;
            if (newValue >= 1 && newValue <= maxElephants) {
                input.value = newValue;
                visualizeElephants();
            }
        };
        
        const increaseElephants = () => changeElephants(1);
        const decreaseElephants = () => changeElephants(-1);
        
        // Initialize
        window.onload = function() {
            getElement('elephantCount').max = maxElephants;
            initializeWorker();
            visualizeElephants();
        };
    </script>
</body>
</html>
